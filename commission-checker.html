<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commission Checker | pacheco.one</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #0f172a;
            --text-light: #64748b;
            --background: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-light);
            font-size: 16px;
        }

        .upload-card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 40px;
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f8fafc;
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: var(--text-light);
        }

        #fileInput {
            display: none;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-box h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
        }

        .info-box p {
            font-size: 14px;
            color: #1e3a8a;
            line-height: 1.6;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 24px;
        }

        .result-card.new-business {
            border-left: 4px solid var(--success);
        }

        .result-card.rewrite {
            border-left: 4px solid var(--warning);
        }

        .result-card.renewal {
            border-left: 4px solid var(--text-light);
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .result-icon {
            font-size: 32px;
        }

        .result-title {
            font-size: 18px;
            font-weight: 700;
        }

        .result-count {
            font-size: 48px;
            font-weight: 800;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 8px;
        }

        .result-subtitle {
            font-size: 14px;
            color: var(--text-light);
        }

        .names-list {
            background: var(--background);
            border-radius: 8px;
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 13px;
            font-family: 'JetBrains Mono', monospace;
        }

        .name-item {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }

        .name-item:last-child {
            border-bottom: none;
        }

        .producer-summary {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 30px;
            margin-bottom: 20px;
        }

        .producer-summary h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text);
        }

        .producer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--background);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .producer-name {
            font-size: 18px;
            font-weight: 700;
        }

        .producer-calc {
            font-size: 14px;
            color: var(--text-light);
            font-family: 'JetBrains Mono', monospace;
        }

        .producer-total {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .btn {
            padding: 14px 28px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Outfit', sans-serif;
        }

        .btn:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--text-light);
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Commission Checker</h1>
            <p>Check commission statements against New Business Log</p>
        </div>

        <div class="upload-card" id="uploadCard">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Upload Commission Statement</div>
                <div class="upload-subtext">Excel (.xlsx) or CSV (.csv) format</div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">

            <div class="info-box">
                <h3>How It Works:</h3>
                <p>
                    1. Upload your commission statement (Excel or CSV format)<br>
                    2. <strong>Supported formats:</strong> Ivantage, Cabrillo, Universal P&C, Slide<br>
                    3. Tool reads: Customer Name, Transaction Type, and Commission Amount<br>
                    4. Checks each transaction against your Business Tracker<br>
                    5. <strong>12-Month Rolling Window:</strong><br>
                    &nbsp;&nbsp;&nbsp;‚Ä¢ <strong>New Business:</strong> Only counts if policy in tracker within last 12 months<br>
                    &nbsp;&nbsp;&nbsp;‚Ä¢ <strong>Re-Writes:</strong> Deducted from commission<br>
                    &nbsp;&nbsp;&nbsp;‚Ä¢ <strong>Endorsements:</strong> Only adds commission if policy written within last 12 months<br>
                    &nbsp;&nbsp;&nbsp;‚Ä¢ <strong>Cancellations:</strong> Only deducts commission if policy written within last 12 months<br>
                    &nbsp;&nbsp;&nbsp;‚Ä¢ <strong>Renewals:</strong> Ignored (no new business commission)<br>
                    6. Shows total commission dollars to pay each producer
                </p>
            </div>
        </div>

        <div class="loading hidden" id="loading">
            <div class="spinner"></div>
            <div>Processing commission statement...</div>
        </div>

        <div id="results" class="hidden">
            <!-- Producer Summary -->
            <div class="producer-summary">
                <h2>üí∞ Producer Commission Summary</h2>
                <div id="producerList"></div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: 700;">
                        <div>TOTAL COMMISSIONABLE POLICIES:</div>
                        <div style="color: #6366f1; font-size: 32px; font-family: 'JetBrains Mono', monospace;" id="grandTotal">0</div>
                    </div>
                </div>
            </div>

            <!-- Results Grid -->
            <div class="results-grid">
                <!-- New Business Card -->
                <div class="result-card new-business">
                    <div class="result-header">
                        <div class="result-icon">‚úÖ</div>
                        <div class="result-title">New Business</div>
                    </div>
                    <div class="result-count" id="newBusinessCount">0</div>
                    <div class="result-subtitle">Found in Business Tracker</div>
                    <div class="names-list" id="newBusinessList"></div>
                </div>

                <!-- MISSING NEW BUSINESS Card -->
                <div class="result-card" id="missingCard" style="border-left: 4px solid #f59e0b; background: #fffbeb;">
                    <div class="result-header">
                        <div class="result-icon">‚ö†Ô∏è</div>
                        <div class="result-title" style="color: #92400e;">Missing from Tracker</div>
                    </div>
                    <div class="result-count" id="missingCount" style="color: #92400e;">0</div>
                    <div class="result-subtitle" style="color: #92400e;">Marked "New Business" but NOT in tracker</div>
                    <div class="names-list" id="missingList" style="background: white; border: 2px solid #fbbf24;"></div>
                </div>

                <!-- Re-Writes Card -->
                <div class="result-card rewrite">
                    <div class="result-header">
                        <div class="result-icon">üîÑ</div>
                        <div class="result-title">Re-Writes</div>
                    </div>
                    <div class="result-count" id="rewriteCount">0</div>
                    <div class="result-subtitle">Deduct from commission</div>
                    <div class="names-list" id="rewriteList"></div>
                </div>

                <!-- Renewals Card -->
                <div class="result-card renewal">
                    <div class="result-header">
                        <div class="result-icon">‚ùå</div>
                        <div class="result-title">Renewals</div>
                    </div>
                    <div class="result-count" id="renewalCount">0</div>
                    <div class="result-subtitle">Not in Business Tracker</div>
                    <div class="names-list" id="renewalList"></div>
                </div>
            </div>

            <div class="actions">
                <button class="btn" onclick="exportResults()">üìä Export to Excel</button>
                <button class="btn btn-secondary" onclick="window.location.href='business-tracker-app.html'">üìà Business Tracker</button>
                <button class="btn btn-secondary" onclick="reset()">üîÑ Check Another Statement</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBUgi5nsyxx0I8JyKT8UG4Nxb7MUr6LIUM",
            authDomain: "new-business-log.firebaseapp.com",
            projectId: "new-business-log",
            storageBucket: "new-business-log.firebasestorage.app",
            messagingSenderId: "634802326842",
            appId: "1:634802326842:web:a490dc09d3b1e25fdfd403"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let businessTrackerPolicies = [];
        let resultsData = {};

        // Check auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadBusinessTracker();
            } else {
                window.location.href = 'login.html?redirect=commission-checker.html';
            }
        });

        async function loadBusinessTracker() {
            try {
                const policiesRef = collection(db, 'policies');
                const snapshot = await getDocs(policiesRef);
                
                businessTrackerPolicies = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`Loaded ${businessTrackerPolicies.length} policies from Business Tracker`);
            } catch (error) {
                console.error('Error loading Business Tracker:', error);
                alert('Error loading Business Tracker data');
            }
        }

        // File upload handling
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('uploadCard').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            try {
                let records = [];

                if (file.name.endsWith('.pdf')) {
                    alert('PDF support coming soon. For now, please export commission statement to Excel/CSV format.');
                    reset();
                    return;
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv')) {
                    records = await parseExcel(file);
                } else {
                    alert('Unsupported file format. Please use Excel (.xlsx) or CSV (.csv) format.');
                    reset();
                    return;
                }

                console.log(`Extracted ${records.length} records from statement`);
                await processRecords(records);

            } catch (error) {
                console.error('Error processing file:', error);
                alert('Error processing file: ' + error.message);
                reset();
            }
        });

        async function parsePDF(file) {
            // For PDF parsing, extract text and find customer names
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }

            // Extract names (simple pattern: capital letters followed by space and more capital letters)
            // This is a basic implementation - may need refinement based on actual PDF format
            const namePattern = /\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)+\b/g;
            const matches = text.match(namePattern) || [];
            
            // Remove duplicates
            return [...new Set(matches)];
        }

        async function parseExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: null });

                        // Try to detect format by looking for key column headers
                        let format = null;
                        let headerRowIndex = -1;

                        for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                            const row = jsonData[i];
                            const rowStr = row.join('|').toLowerCase();
                            
                            // Ivantage format
                            if (rowStr.includes('insured name') && rowStr.includes('reason') && rowStr.includes('amount')) {
                                format = 'ivantage';
                                headerRowIndex = i;
                                break;
                            }
                            // Cabrillo format (CSV converted to array)
                            if (rowStr.includes('insured name') && rowStr.includes('transaction type') && rowStr.includes('commission paid')) {
                                format = 'cabrillo';
                                headerRowIndex = i;
                                break;
                            }
                            // Universal P&C format
                            if (rowStr.includes('insured name') && rowStr.includes('transaction type') && rowStr.includes('commission payable')) {
                                format = 'universal';
                                headerRowIndex = i;
                                break;
                            }
                            // Slide format
                            if (rowStr.includes('insured') && rowStr.includes('new/renewal') && rowStr.includes('commission payable')) {
                                format = 'slide';
                                headerRowIndex = i;
                                break;
                            }
                        }

                        if (!format || headerRowIndex === -1) {
                            reject(new Error('Could not detect commission statement format. Please use Ivantage, Cabrillo, Universal P&C, or Slide format.'));
                            return;
                        }

                        console.log(`Detected format: ${format}`);
                        const records = parseByFormat(jsonData, format, headerRowIndex);
                        resolve(records);

                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function parseByFormat(jsonData, format, headerRowIndex) {
            const headers = jsonData[headerRowIndex];
            const records = [];

            // Find column indices based on format
            let nameCol, reasonCol, amountCol;

            if (format === 'ivantage') {
                nameCol = headers.findIndex(h => h && h.toLowerCase().includes('insured name'));
                reasonCol = headers.findIndex(h => h && h.toLowerCase() === 'reason');
                amountCol = headers.findIndex(h => h && h.toLowerCase() === 'amount');
            } else if (format === 'cabrillo') {
                nameCol = headers.findIndex(h => h && h.toLowerCase().includes('insured name'));
                reasonCol = headers.findIndex(h => h && h.toLowerCase().includes('transaction type'));
                amountCol = headers.findIndex(h => h && h.toLowerCase().includes('commission paid'));
            } else if (format === 'universal') {
                nameCol = headers.findIndex(h => h && h.toLowerCase().includes('insured name'));
                reasonCol = headers.findIndex(h => h && h.toLowerCase().includes('transaction type'));
                amountCol = headers.findIndex(h => h && h.toLowerCase().includes('commission') && !h.toLowerCase().includes('rate'));
            } else if (format === 'slide') {
                nameCol = headers.findIndex(h => h && h.toLowerCase() === 'insured');
                reasonCol = headers.findIndex(h => h && h.toLowerCase().includes('new/renewal'));
                amountCol = headers.findIndex(h => h && h.toLowerCase().includes('commission payable'));
            }

            if (nameCol === -1 || reasonCol === -1 || amountCol === -1) {
                console.error('Could not find required columns', { nameCol, reasonCol, amountCol });
                return [];
            }

            // Parse data rows
            for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                if (!row[nameCol]) continue;

                let reason = row[reasonCol] || '';
                let amount = row[amountCol];

                // Clean up amount - remove $ and commas, handle parentheses as negative
                if (typeof amount === 'string') {
                    amount = amount.replace(/[$,]/g, '');
                    if (amount.includes('(') || amount.includes(')')) {
                        amount = '-' + amount.replace(/[()]/g, '');
                    }
                }
                amount = parseFloat(amount) || 0;

                // Normalize reason text
                reason = String(reason).toLowerCase().trim();

                records.push({
                    name: row[nameCol],
                    reason: reason,
                    amount: amount,
                    format: format
                });
            }

            return records;
        }

        async function parseCSV(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const names = [];

                        for (const line of lines) {
                            const cells = line.split(',');
                            for (const cell of cells) {
                                const cleaned = cell.replace(/"/g, '').trim();
                                if (cleaned.match(/^[A-Z][a-z]+(?:\s+[A-Z][a-z]+)+$/)) {
                                    names.push(cleaned);
                                }
                            }
                        }

                        resolve([...new Set(names)]);
                    } catch (error) {
                        reject(error);
                    }
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function fuzzyMatch(name1, name2) {
            // Simple fuzzy matching - normalize and compare
            const normalize = (str) => str.toLowerCase().replace(/[^a-z]/g, '');
            const n1 = normalize(name1);
            const n2 = normalize(name2);

            // Exact match after normalization
            if (n1 === n2) return true;

            // Check if one contains the other (handles "John Doe" vs "Doe, John")
            if (n1.includes(n2) || n2.includes(n1)) return true;

            // Calculate Levenshtein distance for similarity
            const distance = levenshteinDistance(n1, n2);
            const maxLen = Math.max(n1.length, n2.length);
            const similarity = 1 - distance / maxLen;

            return similarity >= 0.85; // 85% similarity threshold
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        async function processRecords(records) {
            const newBusiness = [];
            const rewrites = [];
            const renewals = [];
            const cancellations = [];
            const endorsements = [];
            const missingPolicies = [];
            const ignoredTransactions = []; // Track what was ignored

            console.log(`\n=== PROCESSING ${records.length} RECORDS ===`);

            // Get date from 12 months ago for rolling window
            const twelveMonthsAgo = new Date();
            twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);

            let debugCounts = {
                newBusinessDetected: 0,
                renewalDetected: 0,
                cancellationDetected: 0,
                endorsementDetected: 0,
                uncategorized: 0
            };

            for (const record of records) {
                const reason = record.reason.toLowerCase();
                
                // Determine transaction type from reason text
                let isNewBusiness = false;
                let isRenewal = false;
                let isCancellation = false;
                let isEndorsement = false;

                // Check for new business (must be exact match to avoid false positives)
                if (reason.includes('new business') || reason === 'new policy') {
                    isNewBusiness = true;
                    debugCounts.newBusinessDetected++;
                    console.log(`NEW BUSINESS: ${record.name} | Reason: "${record.reason}" | Amount: $${record.amount}`);
                }
                // Check for renewal
                else if (reason.includes('renew') || reason === 'ren' || reason.includes('renewal')) {
                    isRenewal = true;
                    debugCounts.renewalDetected++;
                }
                // Check for cancellation
                else if (reason.includes('cancel')) {
                    isCancellation = true;
                    debugCounts.cancellationDetected++;
                }
                // Check for endorsement/policy change
                else if (reason.includes('endorsement') || reason.includes('policy change') || reason.includes('policy endorsement')) {
                    isEndorsement = true;
                    debugCounts.endorsementDetected++;
                }
                // Default to renewal if unclear
                else {
                    isRenewal = true;
                    debugCounts.uncategorized++;
                    console.log(`UNCATEGORIZED (treating as renewal): ${record.name} | Reason: "${record.reason}"`);
                }

                // Process based on transaction type
                if (isNewBusiness) {
                    // Check if in Business Tracker
                    const match = businessTrackerPolicies.find(policy => 
                        fuzzyMatch(policy.customer, record.name)
                    );

                    if (match) {
                        // Check if within 12-month window
                        const policyDate = new Date(match.date);
                        const isRecent = policyDate >= twelveMonthsAgo;

                        if (!isRecent) {
                            // Policy older than 12 months - shouldn't be "new business"
                            console.log(`  ‚ö†Ô∏è Found in tracker but > 12 months old: ${match.date}`);
                            missingPolicies.push({
                                name: record.name,
                                amount: record.amount,
                                reason: 'Policy older than 12 months'
                            });
                            continue;
                        }

                        // Check if it's a re-write
                        const isRewrite = match.referralSource && 
                            match.referralSource.toLowerCase().includes('re-write');

                        if (isRewrite) {
                            console.log(`  üîÑ RE-WRITE: ${match.producer}`);
                            rewrites.push({
                                name: record.name,
                                producer: match.producer,
                                matchedName: match.customer,
                                date: match.date,
                                amount: record.amount
                            });
                        } else {
                            console.log(`  ‚úÖ MATCHED: ${match.producer} | Date: ${match.date}`);
                            newBusiness.push({
                                name: record.name,
                                producer: match.producer,
                                matchedName: match.customer,
                                date: match.date,
                                amount: record.amount
                            });
                        }
                    } else {
                        // Not in tracker but marked as "new business" - FLAG IT
                        console.log(`  ‚ùå NOT IN TRACKER`);
                        missingPolicies.push({
                            name: record.name,
                            amount: record.amount,
                            reason: 'Not found in Business Tracker'
                        });
                    }
                } else if (isRenewal) {
                    // Renewal - no commission for new business
                    renewals.push({
                        name: record.name,
                        amount: record.amount
                    });
                } else if (isCancellation) {
                    // Cancellation - only deduct if policy was new business in last 12 months
                    const match = businessTrackerPolicies.find(policy => 
                        fuzzyMatch(policy.customer, record.name)
                    );

                    if (match) {
                        const policyDate = new Date(match.date);
                        const isRecent = policyDate >= twelveMonthsAgo;
                        
                        if (isRecent) {
                            console.log(`CANCELLATION (within 12 months): ${record.name} | Policy date: ${match.date} | Producer: ${match.producer} | Chargeback: $${Math.abs(record.amount)}`);
                            cancellations.push({
                                name: record.name,
                                producer: match.producer,
                                amount: Math.abs(record.amount),
                                policyDate: match.date
                            });
                        } else {
                            console.log(`CANCELLATION (>12 months old - IGNORE): ${record.name} | Policy date: ${match.date}`);
                            // Don't add to cancellations - policy too old
                            ignoredTransactions.push({
                                name: record.name,
                                type: 'Cancellation',
                                reason: `Policy from ${match.date} (>12 months)`,
                                amount: Math.abs(record.amount)
                            });
                        }
                    } else {
                        console.log(`CANCELLATION (not in tracker - IGNORE): ${record.name}`);
                        ignoredTransactions.push({
                            name: record.name,
                            type: 'Cancellation',
                            reason: 'Not in Business Tracker',
                            amount: Math.abs(record.amount)
                        });
                    }
                } else if (isEndorsement) {
                    // Endorsement - only add commission if policy was new business in last 12 months
                    const match = businessTrackerPolicies.find(policy => 
                        fuzzyMatch(policy.customer, record.name)
                    );

                    if (match) {
                        const policyDate = new Date(match.date);
                        const isRecent = policyDate >= twelveMonthsAgo;
                        
                        if (isRecent) {
                            if (record.amount > 0) {
                                console.log(`ENDORSEMENT (within 12 months): ${record.name} | Policy date: ${match.date} | Producer: ${match.producer} | Commission: $${record.amount}`);
                                endorsements.push({
                                    name: record.name,
                                    producer: match.producer,
                                    amount: record.amount,
                                    policyDate: match.date
                                });
                            } else if (record.amount < 0) {
                                // Negative endorsement = chargeback (within 12 months)
                                console.log(`NEGATIVE ENDORSEMENT (within 12 months): ${record.name} | Policy date: ${match.date} | Producer: ${match.producer} | Chargeback: $${Math.abs(record.amount)}`);
                                cancellations.push({
                                    name: record.name,
                                    producer: match.producer,
                                    amount: Math.abs(record.amount),
                                    policyDate: match.date
                                });
                            }
                        } else {
                            console.log(`ENDORSEMENT (>12 months old - IGNORE): ${record.name} | Policy date: ${match.date} | Amount: $${record.amount}`);
                            // Don't add to endorsements or cancellations - policy too old
                            ignoredTransactions.push({
                                name: record.name,
                                type: record.amount > 0 ? 'Endorsement' : 'Negative Endorsement',
                                reason: `Policy from ${match.date} (>12 months)`,
                                amount: Math.abs(record.amount)
                            });
                        }
                    } else {
                        console.log(`ENDORSEMENT (not in tracker - IGNORE): ${record.name}`);
                        ignoredTransactions.push({
                            name: record.name,
                            type: 'Endorsement',
                            reason: 'Not in Business Tracker',
                            amount: Math.abs(record.amount)
                        });
                    }
                }
            }

            console.log(`\n=== DETECTION SUMMARY ===`);
            console.log(`New Business detected: ${debugCounts.newBusinessDetected}`);
            console.log(`Renewals detected: ${debugCounts.renewalDetected}`);
            console.log(`Cancellations detected: ${debugCounts.cancellationDetected}`);
            console.log(`Endorsements detected: ${debugCounts.endorsementDetected}`);
            console.log(`Uncategorized: ${debugCounts.uncategorized}`);
            
            console.log(`\n=== CATEGORIZATION RESULTS ===`);
            console.log(`New Business (in tracker): ${newBusiness.length}`);
            console.log(`Missing from tracker: ${missingPolicies.length}`);
            console.log(`Re-writes: ${rewrites.length}`);
            console.log(`Renewals: ${renewals.length}`);
            console.log(`Endorsements: ${endorsements.length}`);
            console.log(`Cancellations: ${cancellations.length}`);
            console.log(`Ignored (>12 months or not in tracker): ${ignoredTransactions.length}`);

            resultsData = { newBusiness, rewrites, renewals, cancellations, endorsements, missingPolicies, ignoredTransactions };
            displayResults();
        }

        function displayResults() {
            const { newBusiness, rewrites, renewals, cancellations, endorsements, missingPolicies, ignoredTransactions } = resultsData;

            // Calculate totals
            const nbTotal = newBusiness.reduce((sum, item) => sum + item.amount, 0);
            const rwTotal = rewrites.reduce((sum, item) => sum + item.amount, 0);
            const rnTotal = renewals.reduce((sum, item) => sum + item.amount, 0);
            const missingTotal = missingPolicies.reduce((sum, item) => sum + item.amount, 0);
            const ignoredTotal = ignoredTransactions ? ignoredTransactions.reduce((sum, item) => sum + item.amount, 0) : 0;

            // Update counts with dollar amounts
            document.getElementById('newBusinessCount').innerHTML = `${newBusiness.length}<div style="font-size:18px;font-weight:600;margin-top:8px;">$${nbTotal.toFixed(2)}</div>`;
            document.getElementById('rewriteCount').innerHTML = `${rewrites.length}<div style="font-size:18px;font-weight:600;margin-top:8px;">$${rwTotal.toFixed(2)}</div>`;
            document.getElementById('renewalCount').innerHTML = `${renewals.length}<div style="font-size:18px;font-weight:600;margin-top:8px;">$${rnTotal.toFixed(2)}</div>`;
            document.getElementById('missingCount').innerHTML = `${missingPolicies.length}<div style="font-size:18px;font-weight:600;margin-top:8px;color:#92400e;">$${missingTotal.toFixed(2)}</div>`;

            // Display lists with amounts
            document.getElementById('newBusinessList').innerHTML = newBusiness
                .map(item => `<div class="name-item">${item.name} (${item.producer}) - $${item.amount.toFixed(2)}</div>`)
                .join('') || '<div class="name-item">None found</div>';

            document.getElementById('rewriteList').innerHTML = rewrites
                .map(item => `<div class="name-item">${item.name} (${item.producer}) - $${item.amount.toFixed(2)}</div>`)
                .join('') || '<div class="name-item">None found</div>';

            document.getElementById('renewalList').innerHTML = renewals
                .map(item => `<div class="name-item">${item.name}</div>`)
                .join('') || '<div class="name-item">None found</div>';

            // Display missing policies in the card
            if (missingPolicies.length > 0) {
                document.getElementById('missingList').innerHTML = missingPolicies
                    .map(item => `<div class="name-item" style="color: #92400e; font-weight: 600; background: #fef3c7; padding: 12px; margin: 4px 0; border-radius: 6px;">
                        <div style="font-size: 14px; margin-bottom: 4px;">‚ö†Ô∏è ${item.name}</div>
                        <div style="font-size: 12px; color: #78350f;">Commission: $${item.amount.toFixed(2)} | Reason: ${item.reason}</div>
                    </div>`)
                    .join('') + 
                    '<div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 6px; font-size: 13px; color: #78350f;">' +
                    '<strong>üí° ACTION REQUIRED:</strong><br>' +
                    'These policies are marked as "New Business" on the commission statement but are NOT in your Business Tracker.<br>' +
                    'Please verify and add them to your tracker if they are legitimate new business.' +
                    '</div>';
            } else {
                document.getElementById('missingList').innerHTML = '<div class="name-item" style="color: #15803d; background: #dcfce7; padding: 12px; border-radius: 6px;">‚úÖ All new business policies are in your tracker!</div>';
            }

            // Display ignored transactions (endorsements/cancellations >12 months old)
            if (ignoredTransactions && ignoredTransactions.length > 0) {
                const ignoredHtml = '<div style="margin-top: 20px; padding: 16px; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 8px;">' +
                    '<div style="font-size: 14px; font-weight: 700; color: #475569; margin-bottom: 12px;">‚ÑπÔ∏è Ignored Transactions (' + ignoredTransactions.length + ') - Not affecting commission</div>' +
                    '<div style="font-size: 13px; color: #64748b; margin-bottom: 8px;">These endorsements/cancellations were excluded because the policy is either >12 months old or not in your tracker:</div>' +
                    ignoredTransactions.map(item => 
                        `<div style="font-size: 12px; padding: 8px; background: white; margin: 4px 0; border-radius: 4px; color: #475569;">
                            ${item.name} - ${item.type} ($${item.amount.toFixed(2)}) - ${item.reason}
                        </div>`
                    ).join('') +
                    '</div>';
                document.getElementById('missingList').innerHTML += ignoredHtml;
            }

            // Calculate producer totals
            calculateProducerTotals();

            // Show results
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results').classList.remove('hidden');
        }

        function calculateProducerTotals() {
            const { newBusiness, rewrites, cancellations, endorsements } = resultsData;
            const producerTotals = {};
            
            // Add new business commissions
            newBusiness.forEach(item => {
                if (!producerTotals[item.producer]) {
                    producerTotals[item.producer] = {
                        newAmount: 0,
                        rewriteAmount: 0,
                        endorsementAmount: 0,
                        chargebackAmount: 0,
                        newCount: 0,
                        rewriteCount: 0,
                        endorsementCount: 0,
                        chargebackCount: 0
                    };
                }
                producerTotals[item.producer].newAmount += item.amount;
                producerTotals[item.producer].newCount++;
            });

            // Deduct re-writes
            rewrites.forEach(item => {
                if (!producerTotals[item.producer]) {
                    producerTotals[item.producer] = {
                        newAmount: 0,
                        rewriteAmount: 0,
                        endorsementAmount: 0,
                        chargebackAmount: 0,
                        newCount: 0,
                        rewriteCount: 0,
                        endorsementCount: 0,
                        chargebackCount: 0
                    };
                }
                producerTotals[item.producer].rewriteAmount += item.amount;
                producerTotals[item.producer].rewriteCount++;
            });

            // Add endorsements
            endorsements.forEach(item => {
                if (producerTotals[item.producer]) {
                    producerTotals[item.producer].endorsementAmount += item.amount;
                    producerTotals[item.producer].endorsementCount++;
                }
            });

            // Deduct chargebacks
            cancellations.forEach(item => {
                if (producerTotals[item.producer]) {
                    producerTotals[item.producer].chargebackAmount += item.amount;
                    producerTotals[item.producer].chargebackCount++;
                }
            });

            // Display producer summary
            const producerList = document.getElementById('producerList');
            let grandTotal = 0;

            producerList.innerHTML = Object.entries(producerTotals)
                .map(([producer, totals]) => {
                    const netAmount = totals.newAmount - totals.rewriteAmount + totals.endorsementAmount - totals.chargebackAmount;
                    grandTotal += netAmount;

                    let calcText = `$${totals.newAmount.toFixed(2)} new (${totals.newCount})`;
                    if (totals.rewriteCount > 0) {
                        calcText += ` - $${totals.rewriteAmount.toFixed(2)} re-writes (${totals.rewriteCount})`;
                    }
                    if (totals.endorsementCount > 0) {
                        calcText += ` + $${totals.endorsementAmount.toFixed(2)} endorsements (${totals.endorsementCount} - last 12 months only)`;
                    }
                    if (totals.chargebackCount > 0) {
                        calcText += ` - $${totals.chargebackAmount.toFixed(2)} chargebacks (${totals.chargebackCount} - last 12 months only)`;
                    }

                    return `
                        <div class="producer-row">
                            <div>
                                <div class="producer-name">${producer}</div>
                                <div class="producer-calc">${calcText}</div>
                            </div>
                            <div class="producer-total">$${netAmount.toFixed(2)}</div>
                        </div>
                    `;
                })
                .join('');

            // Update grand total
            document.getElementById('grandTotal').textContent = `$${grandTotal.toFixed(2)}`;
        }

        window.exportResults = function() {
            const { newBusiness, rewrites, renewals, cancellations, endorsements, missingPolicies } = resultsData;
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Producer Summary Sheet
            const producerTotals = {};
            
            newBusiness.forEach(item => {
                if (!producerTotals[item.producer]) {
                    producerTotals[item.producer] = {
                        'Producer': item.producer,
                        'New Business $': 0,
                        'Re-Writes $': 0,
                        'Endorsements $': 0,
                        'Chargebacks $': 0,
                        'Net Commission $': 0
                    };
                }
                producerTotals[item.producer]['New Business $'] += item.amount;
            });

            rewrites.forEach(item => {
                if (producerTotals[item.producer]) {
                    producerTotals[item.producer]['Re-Writes $'] += item.amount;
                }
            });

            endorsements.forEach(item => {
                if (producerTotals[item.producer]) {
                    producerTotals[item.producer]['Endorsements $'] += item.amount;
                }
            });

            cancellations.forEach(item => {
                if (producerTotals[item.producer]) {
                    producerTotals[item.producer]['Chargebacks $'] += item.amount;
                }
            });

            // Calculate net for each producer
            Object.values(producerTotals).forEach(p => {
                p['Net Commission $'] = p['New Business $'] - p['Re-Writes $'] + p['Endorsements $'] - p['Chargebacks $'];
                // Round to 2 decimals
                p['New Business $'] = Math.round(p['New Business $'] * 100) / 100;
                p['Re-Writes $'] = Math.round(p['Re-Writes $'] * 100) / 100;
                p['Endorsements $'] = Math.round(p['Endorsements $'] * 100) / 100;
                p['Chargebacks $'] = Math.round(p['Chargebacks $'] * 100) / 100;
                p['Net Commission $'] = Math.round(p['Net Commission $'] * 100) / 100;
            });

            const summarySheet = XLSX.utils.json_to_sheet(Object.values(producerTotals));
            XLSX.utils.book_append_sheet(wb, summarySheet, 'Producer Summary');
            
            // New Business sheet
            const nbSheet = XLSX.utils.json_to_sheet(
                newBusiness.map(item => ({
                    'Customer': item.name,
                    'Producer': item.producer,
                    'Date': item.date,
                    'Commission $': Math.round(item.amount * 100) / 100,
                    'Type': 'New Business'
                }))
            );
            XLSX.utils.book_append_sheet(wb, nbSheet, 'New Business');
            
            // Re-Writes sheet
            if (rewrites.length > 0) {
                const rwSheet = XLSX.utils.json_to_sheet(
                    rewrites.map(item => ({
                        'Customer': item.name,
                        'Producer': item.producer,
                        'Date': item.date,
                        'Commission $': Math.round(item.amount * 100) / 100,
                        'Type': 'Re-Write (Deduct)'
                    }))
                );
                XLSX.utils.book_append_sheet(wb, rwSheet, 'Re-Writes');
            }

            // Endorsements sheet
            if (endorsements.length > 0) {
                const endSheet = XLSX.utils.json_to_sheet(
                    endorsements.map(item => ({
                        'Customer': item.name,
                        'Producer': item.producer,
                        'Commission $': Math.round(item.amount * 100) / 100,
                        'Type': 'Endorsement (Add)'
                    }))
                );
                XLSX.utils.book_append_sheet(wb, endSheet, 'Endorsements');
            }

            // Cancellations sheet
            if (cancellations.length > 0) {
                const canSheet = XLSX.utils.json_to_sheet(
                    cancellations.map(item => ({
                        'Customer': item.name,
                        'Producer': item.producer,
                        'Chargeback $': Math.round(item.amount * 100) / 100,
                        'Type': 'Cancellation (Deduct)'
                    }))
                );
                XLSX.utils.book_append_sheet(wb, canSheet, 'Cancellations');
            }

            // Missing Policies sheet
            if (missingPolicies.length > 0) {
                const missSheet = XLSX.utils.json_to_sheet(
                    missingPolicies.map(item => ({
                        'Customer': item.name,
                        'Commission $': Math.round(item.amount * 100) / 100,
                        'Reason': item.reason,
                        'Status': 'MISSING - Verify Manually'
                    }))
                );
                XLSX.utils.book_append_sheet(wb, missSheet, 'Missing Policies');
            }
            
            // Renewals sheet
            const rnSheet = XLSX.utils.json_to_sheet(
                renewals.map(item => ({
                    'Customer': item.name,
                    'Commission $': Math.round(item.amount * 100) / 100,
                    'Type': 'Renewal (No Commission Paid)'
                }))
            );
            XLSX.utils.book_append_sheet(wb, rnSheet, 'Renewals');
            
            // Download
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `Commission_Report_${today}.xlsx`);
        };

        window.reset = function() {
            document.getElementById('uploadCard').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('fileInput').value = '';
            resultsData = {};
        };
    </script>
</body>
</html>
