<!DOCTYPE html>
<html>
<head>
    <title>Firebase Connection Test</title>
    <style>
        body { font-family: system-ui; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test { background: #f0f0f0; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .pending { background: #dbeafe; color: #1e40af; }
        pre { background: #1e293b; color: #e2e8f0; padding: 16px; border-radius: 8px; overflow-x: auto; }
        button { background: #6366f1; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #4f46e5; }
    </style>
</head>
<body>
    <h1>ðŸ”¥ Firebase Connection Test</h1>
    
    <div class="test pending" id="status">
        Testing Firebase connection...
    </div>

    <h2>Test Results:</h2>
    <pre id="results">Running tests...</pre>

    <h2>Actions:</h2>
    <button onclick="testRead()">Test Read</button>
    <button onclick="testWrite()">Test Write (active_policies)</button>
    <button onclick="testDelete()">Test Delete (active_policies)</button>
    <button onclick="checkRules()">Show Current Rules</button>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDLDtsu1r5LmF0Hgux5SaMEMF4bcqcPF1g",
            authDomain: "business-tracker-jon.firebaseapp.com",
            projectId: "business-tracker-jon",
            storageBucket: "business-tracker-jon.firebasestorage.app",
            messagingSenderId: "618361217597",
            appId: "1:618361217597:web:5f85c8b5f2d2c3d8e3d8e3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        let testResults = [];

        function log(message) {
            testResults.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            resultsDiv.textContent = testResults.join('\n');
            console.log(message);
        }

        // Auto-run tests on load
        window.addEventListener('load', async () => {
            await runAllTests();
        });

        async function runAllTests() {
            testResults = [];
            log('ðŸ”¥ Firebase Connection Test Starting...\n');
            
            // Test 1: Connection
            try {
                log('âœ… Firebase initialized successfully');
                log(`   Project: ${firebaseConfig.projectId}`);
            } catch (error) {
                log('âŒ Firebase initialization failed: ' + error.message);
                statusDiv.className = 'test error';
                statusDiv.textContent = 'âŒ Firebase initialization failed';
                return;
            }

            // Test 2: Read policies
            log('\nðŸ“– Test 1: Reading "policies" collection...');
            try {
                const policiesRef = collection(db, 'policies');
                const snapshot = await getDocs(policiesRef);
                log(`âœ… READ policies: Success! Found ${snapshot.size} documents`);
            } catch (error) {
                log(`âŒ READ policies: ${error.code} - ${error.message}`);
            }

            // Test 3: Read quotes
            log('\nðŸ“– Test 2: Reading "quotes" collection...');
            try {
                const quotesRef = collection(db, 'quotes');
                const snapshot = await getDocs(quotesRef);
                log(`âœ… READ quotes: Success! Found ${snapshot.size} documents`);
            } catch (error) {
                log(`âŒ READ quotes: ${error.code} - ${error.message}`);
            }

            // Test 4: Read active_policies
            log('\nðŸ“– Test 3: Reading "active_policies" collection...');
            try {
                const activeRef = collection(db, 'active_policies');
                const snapshot = await getDocs(activeRef);
                log(`âœ… READ active_policies: Success! Found ${snapshot.size} documents`);
            } catch (error) {
                log(`âŒ READ active_policies: ${error.code} - ${error.message}`);
            }

            // Test 5: Write test to active_policies
            log('\nâœï¸ Test 4: Writing test document to "active_policies"...');
            try {
                const activeRef = collection(db, 'active_policies');
                const testDoc = {
                    firstName: 'TEST',
                    lastName: 'USER',
                    fullName: 'TEST USER',
                    testDocument: true,
                    createdAt: new Date().toISOString()
                };
                const docRef = await addDoc(activeRef, testDoc);
                log(`âœ… WRITE active_policies: Success! Doc ID: ${docRef.id}`);
                
                // Clean up test doc
                await deleteDoc(docRef);
                log(`âœ… DELETE test document: Success!`);
            } catch (error) {
                log(`âŒ WRITE active_policies: ${error.code} - ${error.message}`);
                log(`   This is the main issue! Rules are blocking writes.`);
            }

            log('\n' + '='.repeat(50));
            log('TEST SUMMARY:');
            
            const hasErrors = testResults.some(r => r.includes('âŒ'));
            if (hasErrors) {
                statusDiv.className = 'test error';
                statusDiv.textContent = 'âŒ Some tests failed - Check results below';
                log('âŒ FAILED: Firebase rules need to be updated');
                log('\nðŸ“‹ SOLUTION: Update Firebase rules to:');
                log(`
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /policies/{document=**} {
      allow read, write: if true;
    }
    match /quotes/{document=**} {
      allow read, write: if true;
    }
    match /active_policies/{document=**} {
      allow read, write: if true;
    }
  }
}
                `.trim());
            } else {
                statusDiv.className = 'test success';
                statusDiv.textContent = 'âœ… All tests passed! Firebase is working correctly';
                log('âœ… SUCCESS: All Firebase operations work correctly');
            }
        }

        // Make functions available globally
        window.testRead = async () => {
            log('\nðŸ“– Manual Read Test...');
            try {
                const activeRef = collection(db, 'active_policies');
                const snapshot = await getDocs(activeRef);
                log(`âœ… READ: Found ${snapshot.size} documents`);
            } catch (error) {
                log(`âŒ READ: ${error.code} - ${error.message}`);
            }
        };

        window.testWrite = async () => {
            log('\nâœï¸ Manual Write Test...');
            try {
                const activeRef = collection(db, 'active_policies');
                const docRef = await addDoc(activeRef, {
                    firstName: 'MANUAL',
                    lastName: 'TEST',
                    fullName: 'MANUAL TEST',
                    testDocument: true,
                    createdAt: new Date().toISOString()
                });
                log(`âœ… WRITE: Success! Doc ID: ${docRef.id}`);
            } catch (error) {
                log(`âŒ WRITE: ${error.code} - ${error.message}`);
            }
        };

        window.testDelete = async () => {
            log('\nðŸ—‘ï¸ Manual Delete Test...');
            try {
                const activeRef = collection(db, 'active_policies');
                const snapshot = await getDocs(activeRef);
                if (snapshot.size > 0) {
                    const firstDoc = snapshot.docs[0];
                    await deleteDoc(firstDoc.ref);
                    log(`âœ… DELETE: Deleted doc ${firstDoc.id}`);
                } else {
                    log(`âš ï¸ No documents to delete`);
                }
            } catch (error) {
                log(`âŒ DELETE: ${error.code} - ${error.message}`);
            }
        };

        window.checkRules = () => {
            log('\nðŸ“‹ To check Firebase rules:');
            log('1. Go to: https://console.firebase.google.com');
            log('2. Select: business-tracker-jon');
            log('3. Click: Firestore Database');
            log('4. Click: Rules tab');
            log('\nCopy your current rules and share them!');
        };
    </script>
</body>
</html>
